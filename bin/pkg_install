#!/bin/bash
#
# Usage: ./pkg_install [--pacman <pkg>] [--apt-get <pkg>] [executable]
# If the executable is specified and exists the script exits.
# Script tries to install the executable using the first found package manager.
# The package name is either the pkg specified for the found package manager
# or, as a fallback, the positional executable.
#
# Author Joni Rapo 28.12.2024

set -e


DEBUG=false

EXECUTABLE=
PACMAN=
APT_GET=

# Parsing arguments src: https://stackoverflow.com/questions/192249/how-do-i-parse-command-line-arguments-in-bash
LONGOPTS=debug,pacman:,apt-get:

PARSED=$(getopt --options='' --longoptions=$LONGOPTS --name "$0" -- "$@") || exit 1
eval set -- "$PARSED"

while true; do
  case "$1" in
    --debug)
      DEBUG=true
      shift
      ;;
    --pacman)
      PACMAN="$2"
      shift 2
      ;;
    --apt-get)
      APT_GET="$2"
      shift 2
      ;;
    --)
      shift
      break # -- signals end of optional arguments
      ;;
    *)
      echo "wow, something went wrong"
      exit 1
      ;;
  esac
done


if [[ ! -z "$1" ]]; then
  EXECUTABLE="$1"
fi


# debug
if $DEBUG; then
  echo "EXECUTABLE=$EXECUTABLE"
  echo "PACMAN:$PACMAN"
  echo "APT_GET:$APT_GET"
  echo "LEFTOVER_ARGS:$@"
fi


if command -v "$EXECUTABLE" 2>&1 >/dev/null; then
  exit 0
fi


if command -v pacman 2>&1 >/dev/null; then
  sudo pacman -Sy "${PACMAN:=$EXECUTABLE}"
elif command -v apt-get 2>&1 >/dev/null; then
  sudo apt-get -Sy "${APT_GET:=$EXECUTABLE}"
else
  echo "Package manager not supported or not found and installing from source is not yet supported."
  exit 1
fi

